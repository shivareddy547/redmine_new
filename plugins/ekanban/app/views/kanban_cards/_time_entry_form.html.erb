
<%= error_messages_for 'time_entry' %>
<%= back_url_hidden_field_tag %>
<span id="time"></span>
<div class="box tabular">
  <% if @time_entry.new_record? %>
      <% if params[:project_id] %>
          <%= hidden_field_tag 'project_id', params[:project_id],:required => true %>
      <% elsif params[:issue_id] %>
          <%= hidden_field_tag 'issue_id', params[:issue_id],:required => true %>
      <% else %>
          <p><%= f.select :project_id, project_tree_options_for_select(Project.allowed_to(:log_time).all, :selected => @time_entry.project, :include_blank => true),:required => true %></p>
      <% end %>
  <% end %>
  <p>
    <%= f.text_field :issue_id, :size => 6,:required => true %>
    <span id="time_entry_issue"><%= h("#{@time_entry.issue.tracker.name} ##{@time_entry.issue.id}: #{@time_entry.issue.subject}") if @time_entry.issue %></span>
  </p>
  <p><%= f.text_field :spent_on, :size => 10, :required => true %><%= calendar_for('time_entry_spent_on') %></p>
  <p><%= f.text_field :hours, :size => 6, :required => true %></p>
  <p><%= f.text_field :comments, :size => 100, :maxlength => 255 %></p>
  <p><%= f.select :activity_id, activity_collection_for_select_options(@time_entry), :required => true %></p>
  <% @time_entry.custom_field_values.each do |value| %>
      <p><%= custom_field_tag_with_label :time_entry, value %></p>
  <% end %>
  <%#= call_hook(:view_timelog_edit_form_bottom, { :time_entry => @time_entry, :form => f }) %>
</div>

<%= javascript_tag do %>
    observeAutocompleteField('time_entry_issue_id', '<%= escape_javascript auto_complete_issues_path(:project_id => @project, :scope => (@project ? nil : 'all'))%>', {
    select: function(event, ui) {
    $('#time_entry').text(ui.item.label);
    }
    });


<% end %>
<script>

    $("#new_time_entry #new_time_entry_submit").click(function(){
        $.ajax({
            url: "/kanban_cards/log_entry_create?" + $('#new_time_entry').serialize(), // Route to the Script Controller method
            type: "POST",
            dataType: "json",
            // This goes to Controller in params hash, i.e. params[:file_name]
            complete: function () {
            },
            success: function (data) {

                console.log(data.errors);
                if(data.errors) {
                    $('#errorExplanation').css("display", "block");
                    $('#errorExplanation ul').empty();
                    $('#errorExplanation ul').append(data.errors)
                }
                else
                {
                    if($("#TimeEntrypopupWindow #TimeEntrypopupWindowBody form.new_time_entry").length > 0)
                    {
                        $("#TimeEntrypopupWindow #TimeEntrypopupWindowBody form.new_time_entry").remove();
                        window.location.reload();
                    }
                }


            }

        });


    });

</script>

<style>
.ui-autocomplete {
        z-index : 1015 !important;
    }
</style>